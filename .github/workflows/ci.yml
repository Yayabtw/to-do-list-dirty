name: CI

on:
  push:
    branches: [ main, dev-quality-system ]
  pull_request:
    branches: [ main, dev-quality-system ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Send notification (start)
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          pip install pipenv || true
          pipenv run python scripts/send_notification.py start "üöÄ CI d√©marr√©e pour ${{ github.repository }} sur ${{ github.ref_name }}" || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install pipenv
        run: pip install pipenv

      - name: Install Python dependencies
        run: pipenv install --dev

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Node dependencies
        run: npm ci

      - name: Set up ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Run linter
        run: pipenv run ruff check . --extend-ignore N802

      - name: Prepare database (SQLite)
        run: |
          pipenv run python manage.py migrate
          pipenv run python manage.py loaddata tasks/fixtures/dataset.json

      - name: Run Django tests (JSON)
        run: pipenv run python manage.py test tasks.tests --testrunner=tests.json_test_runner.JSONTestRunner
        continue-on-error: true

      - name: Start Django server
        env:
          DJANGO_SETTINGS_MODULE: todo.settings
        run: |
          pipenv run python manage.py runserver 127.0.0.1:8000 &
          sleep 5
          curl -f http://127.0.0.1:8000/ || exit 1

      - name: Run E2E tests (Selenium)
        run: |
          pipenv run python tests/e2e/tc016_crud_10_tasks.py || true
          pipenv run python tests/e2e/tc017_cross_impact.py || true
        continue-on-error: true

      - name: Run accessibility tests (pa11y-ci)
        run: |
          npx pa11y-ci --config .pa11yci.json --json > result_test_accessibility.json 2>&1 || echo '{"errors": true, "message": "Accessibility tests failed"}' > result_test_accessibility.json
        continue-on-error: true

      - name: Generate test report (console)
        run: pipenv run python test_report.py > test_report_output.txt 2>&1 || true

      - name: Generate PR report (Markdown)
        if: github.event_name == 'pull_request'
        run: pipenv run python scripts/generate_pr_report.py > pr_report.md 2>&1 || echo '# üìä Rapport des Tests CI\n\n‚ö†Ô∏è Erreur lors de la g√©n√©ration du rapport.' > pr_report.md

      - name: Generate delivery certificate PDF
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          pipenv run python scripts/generate_delivery_certificate.py bon_livraison_tests.pdf || echo "‚ö†Ô∏è Erreur lors de la g√©n√©ration du PDF"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            result_test_auto.json
            result_test_selenium.json
            result_test_accessibility.json
            test_report_output.txt
            pr_report.md
            bon_livraison_tests.pdf

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const reportPath = path.join(process.env.GITHUB_WORKSPACE, 'pr_report.md');
            let comment = '## üìä Rapport des Tests CI\n\n';

            try {
              comment = fs.readFileSync(reportPath, 'utf8');
            } catch (e) {
              console.log('Erreur lecture rapport:', e);
              comment += '‚ö†Ô∏è Impossible de g√©n√©rer le rapport complet.\n\n';
              try {
                const simpleReport = fs.readFileSync(path.join(process.env.GITHUB_WORKSPACE, 'test_report_output.txt'), 'utf8');
                comment += '```\n' + simpleReport + '\n```\n';
              } catch (e2) {
                comment += 'Aucun rapport disponible.\n';
              }
            }

            // Ajouter le bon de livraison PDF si disponible (uniquement pour PR vers main)
            const pdfPath = path.join(process.env.GITHUB_WORKSPACE, 'bon_livraison_tests.pdf');
            if (fs.existsSync(pdfPath) && context.payload.pull_request.base.ref === 'main') {
              // Uploader le PDF comme asset et cr√©er un lien
              const pdfBuffer = fs.readFileSync(pdfPath);
              const pdfBase64 = pdfBuffer.toString('base64');
              
              // Cr√©er un commentaire avec le PDF en pi√®ce jointe via l'API
              // Note: GitHub ne supporte pas directement les fichiers dans les commentaires,
              // donc on upload le PDF comme artefact et on ajoute un lien dans le commentaire
              const runId = context.runId;
              const repo = context.repo;
              const artifactUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}`;
              
              comment += '\n\n---\n\n';
              comment += '## üìÑ Bon de Livraison - Certificat de Tests\n\n';
              comment += `üìé Le bon de livraison PDF est disponible dans les [artefacts de cette ex√©cution](${artifactUrl}).\n\n`;
              comment += 'Le PDF contient la liste compl√®te des tests, leurs r√©sultats et l\'horodatage de r√©alisation.';
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              (c.body.includes('Rapport des Tests CI') || c.body.includes('R√©sultats des Tests CI'))
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

      - name: Send notification (success)
        if: success()
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          pipenv run python scripts/send_notification.py success "‚úÖ Tous les tests sont pass√©s avec succ√®s !" || true

      - name: Send notification (failure)
        if: failure()
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          pipenv run python scripts/send_notification.py failure "‚ùå La CI a √©chou√©. V√©rifiez les logs pour plus de d√©tails." || true

